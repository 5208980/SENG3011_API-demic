{% extends "layout.html" %}

{% block body %}
    {% include 'nav.html' %}

    <section class="page-header bg-header">
        <h2 class="header-content container text-bold">Latest World Covid-19 New</h2>
    </section>

    <div class="text-center text-bold">Read news from period</div>
    <form action="{{ url_for('latest_news') }}" method="get" class="container">
        <div class="form-row">
            <div class="form-group col-md-6">
                <label for="inputEmail4">Start date</label>
                <input type="date" id="start_date" name="start_date" class="datepicker form-control">
            </div>
            <div class="form-group col-md-6">
                <label for="inputPassword4">End Date</label>
                <input type="date" id="end_date" name="end_date" class="datepicker form-control">
            </div>
        </div>

        <div class="container">
            <div class="row">
                <div class="col text-center">
                    <button type="submit" class="btn btn-primary">Search</button>
                </div>
            </div>
        </div>
  </form>

    <section class="container pt-5">
        <div class="row">
            <div class="col-sm-8">
                <div id="article" class="row">
                    {% for article in articles['articles'] -%}
                        <div class="col-md-6">
                            <div class="card news-article clear-border overflow-hidden">
                                <div class="card-body">
                                    <a href="{{ article.url }}" class="news-headline text-bold" target="_blank">
                                        {{ article.headline.strip() }}
                                    </a>
                                    <div class="news-text">
                                        {{ article.main_text }}
                                    </div>
                                </div>
                                <div class="card-footer news-footer clear-border">
                                    {{ article.date_of_publication }}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <div class="col-sm-4" id="other">
                <section class="container pt-3 pb-3 hr">
                    <div class="row text-center">
                        <div class="col-lg-4">
                            <div>Confirmed</div>
                            <h5 id="total-confirmed">0</h5>
                        </div>
                        <div class="col-lg-4">
                            <div>Deaths</div>
                            <h5 id="total-deaths">0</h5>
                        </div>
                        <div class="col-lg-4">
                            <div>Recovered</div>
                            <h5 id="total-recovered">0</h5>
                        </div>
                    </div>
                </section>

                <section id="side-news">
                    <h4 class="content-title pt-2">Side News</h4>
                </section>

                <section id="trends">
                    <h4 class="content-title pt-2">Trending Searches</h4>
                    {% for trend in trends%}
                        {% set search = trend|replace(" ", "+") %}
                        <div class="">
                            <a href="http://www.google.com/search?q={{ search }}" target="_blank"> {{ trend }}</a>
                        </div>
                    {% endfor %}
                </section>
            </div>
        </div>
    </section>

    <script>
        let start = '{{ start }}';
        let end = '{{ end }}';

        var APIDEMICURL = `http://api-demic.herokuapp.com/v1.1/articles?start_date=${start}&end_date=${end}&key_term=covid19,coronavirus&limit=20`;

        let apiP = fetch(APIDEMICURL).then(r => r.json());
        // Original now dep: https://corona-virus-stats.herokuapp.com/api/v1/cases/general-stats
        let apiG = fetch('https://api.thevirustracker.com/free-api?global=stats').then(r => r.json());  // Live main API
        Promise.all([apiP, apiG]).then(values => {
            let apiJson = values[0];
            let globalCases = values[1].results[0];

            let articleRow = document.getElementById('article');
            let sideNews = document.getElementById('side-news');

            console.log(apiJson);
            if(!apiJson.hasOwnProperty('articles')) {
                let col = document.createElement("div");
                col.classList.add('hr', 'pt-2', 'pb-3');
                col.innerText = `${apiJson.message.trim()}`;
                sideNews.appendChild(col);
                return col;
            } else {
                let apiArticles = apiJson.articles.reverse();
                for(i in apiArticles) {
                    let article = apiArticles[i];

                    let col = createSide(article);
                    sideNews.appendChild(col);
                }
            }
            document.getElementById('total-confirmed').innerText = `${globalCases.total_cases.toLocaleString("en")}`;
            document.getElementById('total-deaths').innerText = `${globalCases.total_deaths.toLocaleString("en")}`;
            document.getElementById('total-recovered').innerText = `${globalCases.total_recovered.toLocaleString("en")}`;

        });

        function createSide(article) {
            let col = document.createElement("div");
            col.classList.add('hr', 'pt-2', 'pb-3');

            let cardHeadline = document.createElement("a");
            cardHeadline.classList.add('side-news-headline');
            cardHeadline.setAttribute('href', `${article['url']}`);
            cardHeadline.setAttribute('target', '_blank');
            cardHeadline.innerText = `${article['headline'].trim()}`;
            col.appendChild(cardHeadline);

            return col;
        }
    </script >

    {% include 'footer.html' %}
{% endblock %}
